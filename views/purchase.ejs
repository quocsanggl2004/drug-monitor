<!-- add header -->
<%- include('includes/_header') %>
<!-- end header -->
<!-- Main section -->
<main id="main">

	<h2>Calculate Drugs to purchase</h2>
	<p>For how many days do you want to purchase drugs?</p> <form id="drug_days"> <input type="number" id="days" value="30"> <button type="submit">Enter</button> </form>

	<table id="purchase_table"> 
	 <thead>
	  <tr>
	   <th>ID</th>
	   <th>Drug Name</th>
	   <th>Cards to Buy</th>
	   <th>Packs to Buy</th>
	   <th>Purchase</th>
	  </tr>
	 </thead>
	 <tbody id="purchase_body">
	  <!-- Kết quả sẽ được cập nhật bằng JS -->
	 </tbody>
	</table>
</main>
<script>

function renderTable(data) {
	const body = document.getElementById('purchase_body');
	body.innerHTML = '';
	data.forEach((drug, idx) => {
		body.innerHTML += `<tr>
			<td>${idx + 1}</td>
			<td>${drug.drugName}</td>
			<td>${drug.cardsToBuy}</td>
			<td>${drug.packsToBuy}</td>
			<td>
				<form class="purchase-form" data-id="${drug.id}">
					<input type="number" name="quantity" min="1" max="${drug.packsToBuy}" value="1" style="width:60px;">
					<button type="submit">Buy</button>
				</form>
			</td>
		</tr>`;
	});
	// Gắn sự kiện cho các form mua thuốc
	document.querySelectorAll('.purchase-form').forEach(form => {
		form.addEventListener('submit', function(e) {
			e.preventDefault();
			const id = form.getAttribute('data-id');
			const quantity = form.querySelector('input[name="quantity"]').value;
			fetch('/api/purchase', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify({ id, quantity })
			})
			.then(res => res.json())
			.then(data => {
				alert(data.message || 'Đã mua thành công!');
				// Sau khi mua, reload lại bảng
				document.getElementById('drug_days').dispatchEvent(new Event('submit'));
			})
			.catch(() => alert('Lỗi mua thuốc!'));
		});
	});
}

document.getElementById('drug_days').addEventListener('submit', function(e) {
	e.preventDefault();
	const days = document.getElementById('days').value;
	fetch('/api/calculate-purchase', {
		method: 'POST',
		headers: { 'Content-Type': 'application/json' },
		body: JSON.stringify({ days })
	})
		.then(res => res.json())
		.then(data => {
			renderTable(data);
		})
		.catch(() => alert('Lỗi tính toán!'));
});

// Tải bảng mặc định với số ngày ban đầu
window.addEventListener('DOMContentLoaded', function() {
	const days = document.getElementById('days').value;
	fetch('/api/calculate-purchase', {
		method: 'POST',
		headers: { 'Content-Type': 'application/json' },
		body: JSON.stringify({ days })
	})
		.then(res => res.json())
		.then(data => {
			renderTable(data);
		});
});
</script>
<!-- add footer -->
<%- include('includes/_footer') %>
<!-- end footer-->

